<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat History - Lelouch AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            color: #EEEEEE;
            min-height: 100vh;
            margin: 0;
            background: linear-gradient(120deg, #222831 0%, #393E46 50%, #00ADB5 100%);
            background-size: 200% 200%;
            animation: gradientMove 8s ease-in-out infinite;
        }
        
        /* Mobile responsive styles */
        @media (max-width: 640px) {
            .min-h-screen {
                padding: 0.5rem;
            }
            .glass-card {
                border-radius: 1rem;
                padding: 1rem !important;
            }
            .chat-item {
                padding: 1rem !important;
            }
            header {
                flex-direction: column;
                gap: 1rem;
                padding: 1rem !important;
            }
            header .flex {
                flex-wrap: wrap;
                justify-content: center;
                gap: 0.5rem;
            }
        }
        
        @media (max-width: 768px) {
            .max-w-6xl {
                max-width: 100%;
                padding: 0 1rem;
            }
        }
        @keyframes gradientMove {
            0% {background-position: 0% 50%;}
            50% {background-position: 100% 50%;}
            100% {background-position: 0% 50%;}
        }
        .glass-card {
            background: rgba(34, 40, 49, 0.45);
            border-radius: 2rem;
            box-shadow: 0 8px 32px 0 rgba(0, 173, 181, 0.37);
            backdrop-filter: blur(24px);
            border: 1px solid rgba(238, 238, 238, 0.12);
        }
        .chat-item {
            background: rgba(57, 62, 70, 0.6);
            border-radius: 1rem;
            border: 1px solid rgba(0, 173, 181, 0.2);
            transition: all 0.3s ease;
        }
        .chat-item:hover {
            border-color: rgba(0, 173, 181, 0.5);
            transform: translateY(-2px);
        }
        .markdown-content {
            line-height: 1.6;
        }
        .markdown-content h1, .markdown-content h2, .markdown-content h3 {
            color: #00ADB5;
            margin: 0.5em 0;
        }
        .markdown-content p {
            margin: 0.5em 0;
        }
        .markdown-content code {
            background: rgba(0, 173, 181, 0.2);
            padding: 0.125em 0.25em;
            border-radius: 0.25rem;
            font-size: 0.875em;
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(34, 40, 49, 0.3);
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #00ADB5, #393E46);
            border-radius: 10px;
            border: 1px solid rgba(0, 173, 181, 0.2);
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #393E46, #00ADB5);
        }
        
        /* Firefox scrollbar */
        * {
            scrollbar-width: thin;
            scrollbar-color: #00ADB5 rgba(34, 40, 49, 0.3);
        }
    </style>
</head>
<body>
    <div class="min-h-screen p-4">
        <!-- Header -->
        <header class="w-full max-w-6xl mx-auto flex flex-col md:flex-row justify-between items-center px-4 md:px-8 py-4 mb-6 glass-card gap-4">
            <div class="flex items-center justify-center md:justify-start">
                <span class="bg-teal-600 rounded-full p-2 mr-3" style="background-color: #00ADB5;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" class="md:w-6 md:h-6" fill="white" viewBox="0 0 16 16">
                        <path d="M5 3a3 3 0 0 1 6 0v5a3 3 0 0 1-6 0V3z"/>
                        <path d="M3.5 6.5A.5.5 0 0 1 4 7v1a4 4 0 0 0 8 0V7a.5.5 0 0 1 1 0v1a5 5 0 0 1-4.5 4.975V15h3a.5.5 0 0 1 0 1h-7a.5.5 0 0 1 0-1h3v-2.025A5 5 0 0 1 3 8V7a.5.5 0 0 1 .5-.5z"/>
                    </svg>
                </span>
                <div class="text-center md:text-left">
                    <h1 class="text-xl md:text-2xl font-bold">Chat History</h1>
                    <p class="text-sm md:text-base">Your conversation history with Lelouch AI</p>
                </div>
            </div>
            <div class="flex flex-wrap items-center justify-center gap-2 md:gap-4">
                <div id="userInfo" class="text-xs md:text-sm"></div>
                <a href="/" class="px-3 md:px-4 py-2 rounded-lg text-sm" style="background-color: #00ADB5; color: #EEEEEE;">
                    ← Back to Chat
                </a>
            </div>
        </header>

        <!-- Main Content -->
        <div class="max-w-6xl mx-auto">
            <div id="loadingMessage" class="text-center py-8">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-teal-400"></div>
                <p class="mt-2">Loading your chat history...</p>
            </div>

            <div id="noHistoryMessage" class="text-center py-12 hidden">
                <div class="glass-card p-8">
                    <svg class="mx-auto h-16 w-16 text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                    </svg>
                    <h3 class="text-xl font-medium mb-2">No chat history yet</h3>
                    <p class="text-gray-300 mb-4">Start a conversation with Lelouch AI to see your history here.</p>
                    <a href="/" class="inline-block px-6 py-3 rounded-lg" style="background-color: #00ADB5; color: #EEEEEE;">
                        Start Chatting
                    </a>
                </div>
            </div>

            <div id="historyContainer" class="space-y-6 hidden">
                <!-- Chat history items will be inserted here -->
            </div>
        </div>
    </div>

    <script>
        // Initialize Supabase
        const supabaseUrl = '{{ supabase_url }}';
        const supabaseKey = '{{ supabase_key }}';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        // DOM elements
        const loadingMessage = document.getElementById('loadingMessage');
        const noHistoryMessage = document.getElementById('noHistoryMessage');
        const historyContainer = document.getElementById('historyContainer');
        const userInfo = document.getElementById('userInfo');

        let currentUser = null;

        // Check authentication and load history
        async function init() {
            const { data: { user } } = await supabase.auth.getUser();
            
            if (!user) {
                window.location.href = '/auth';
                return;
            }

            currentUser = user;
            userInfo.textContent = user.email;
            
            await loadChatHistory();
        }

        // Load chat history from API
        async function loadChatHistory() {
            try {
                const response = await fetch(`/api/chat-history/${currentUser.id}`);
                const result = await response.json();

                loadingMessage.classList.add('hidden');

                if (result.success && result.data.length > 0) {
                    displayChatHistory(result.data);
                    historyContainer.classList.remove('hidden');
                } else {
                    noHistoryMessage.classList.remove('hidden');
                }
            } catch (error) {
                console.error('Error loading chat history:', error);
                loadingMessage.classList.add('hidden');
                noHistoryMessage.classList.remove('hidden');
            }
        }

        // Display chat history
        function displayChatHistory(chatData) {
            historyContainer.innerHTML = '';

            chatData.forEach((chat, index) => {
                const chatItem = document.createElement('div');
                chatItem.className = 'chat-item p-6';

                const date = new Date(chat.created_at).toLocaleString();
                const messageCount = chat.chat_data.length;
                
                // Get first user message as preview
                const firstUserMessage = chat.chat_data.find(msg => msg.sender === 'user');
                const preview = firstUserMessage ? firstUserMessage.text.substring(0, 100) + '...' : 'No messages';

                chatItem.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="text-lg font-semibold" style="color: #00ADB5;">Chat Session ${chatData.length - index}</h3>
                            <p class="text-sm text-gray-300">${date} • ${messageCount} messages</p>
                        </div>
                        <button onclick="toggleChat(${index})" class="text-sm px-3 py-1 rounded" style="background-color: #393E46; color: #EEEEEE;">
                            <span id="toggle-${index}">Show</span>
                        </button>
                    </div>
                    <p class="text-gray-300 mb-4">${preview}</p>
                    <div id="chat-${index}" class="hidden">
                        <div class="border-t border-gray-600 pt-4">
                            <div class="space-y-3 max-h-96 overflow-y-auto">
                                ${chat.chat_data.map(msg => `
                                    <div class="flex">
                                        <span class="font-medium mr-2" style="color: ${msg.sender === 'user' ? '#00ADB5' : '#00ADB5'};">
                                            ${msg.sender === 'user' ? 'You:' : 'Lelouch AI:'}
                                        </span>
                                        <div class="flex-1 ${msg.sender === 'ai' ? 'markdown-content' : ''}" style="color: #EEEEEE;">
                                            ${msg.sender === 'ai' ? marked.parse(msg.text) : msg.text}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;

                historyContainer.appendChild(chatItem);
            });
        }

        // Toggle chat visibility
        function toggleChat(index) {
            const chatDiv = document.getElementById(`chat-${index}`);
            const toggleBtn = document.getElementById(`toggle-${index}`);
            
            if (chatDiv.classList.contains('hidden')) {
                chatDiv.classList.remove('hidden');
                toggleBtn.textContent = 'Hide';
            } else {
                chatDiv.classList.add('hidden');
                toggleBtn.textContent = 'Show';
            }
        }

        // Initialize the page
        init();
    </script>
</body>
</html>